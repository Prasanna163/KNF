<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KNF Control</title>
  <meta name="description"
    content="KNF-Core GUI V3 web interface for computational chemistry workflows" />
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}" />
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
  <script src="https://3Dmol.org/build/3Dmol-min.js" charset="utf-8"></script>
</head>

<body>
  <!-- ===== Top Bar ===== -->
  <header class="topbar reveal">
    <div>
      <p class="kicker">Computational Chemistry Control Deck</p>
      <h1>KNF Control</h1>
    </div>
    <div class="status-badge" id="apiHealth">API: checking...</div>
  </header>

  <main class="layout">
    <!-- ===== Run Configuration ===== -->
    <section class="panel reveal stagger-1">
      <h2>Run Configuration</h2>
      <form id="runForm" class="form-grid">

        <!-- Drop Zone -->
        <div class="drop-zone" id="dropZone">
          <span class="drop-icon">+</span>
          Drop molecule file here or click to browse
          <div class="filename" id="dropFilename"></div>
        </div>
        <input type="file" id="fileInput" accept=".xyz,.sdf,.mol,.pdb,.mol2" style="display:none" />

        <label>
          Input Path
          <div class="path-row">
            <input id="inputPath" name="input_path" type="text" placeholder="E:\path\to\molecule.or.folder" required />
            <button type="button" class="btn btn-secondary browse-btn" id="browseInputFile">File…</button>
            <button type="button" class="btn btn-secondary browse-btn" id="browseInputDir">Folder…</button>
          </div>
        </label>
        <label>
          Output Directory (optional)
          <div class="path-row">
            <input id="outputDir" name="output_dir" type="text" placeholder="E:\path\to\Results" />
            <button type="button" class="btn btn-secondary browse-btn" id="browseOutputDir">Browse…</button>
          </div>
        </label>

        <label>
          Processing Mode
          <select id="processing" name="processing">
            <option value="single">single</option>
            <option value="multi">multi</option>
          </select>
        </label>
        <label>
          Workers (optional)
          <input id="workers" name="workers" type="number" min="1" placeholder="auto" />
        </label>

        <label>
          Charge
          <input id="charge" name="charge" type="number" value="0" />
        </label>
        <label>
          Spin Multiplicity
          <input id="spin" name="spin" type="number" min="1" value="1" />
        </label>

        <label>
          RAM Per Job (MB)
          <input id="ramPerJob" name="ram_per_job" type="number" step="0.1" min="1" value="50" />
        </label>

        <div class="flags" id="flags">
          <label><input type="checkbox" id="force" /> Force Recompute</label>
          <label><input type="checkbox" id="clean" /> Clean Existing Result Dir</label>
          <label><input type="checkbox" id="debug" /> Debug Logs</label>
          <label><input type="checkbox" id="storageEfficient" /> Storage Efficient Cleanup</label>
          <label><input type="checkbox" id="refreshAutoconfig" /> Refresh Autoconfig</label>
          <label><input type="checkbox" id="quietConfig" /> Quiet Config Banner</label>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary" id="runBtn">Launch Job</button>
          <button type="button" class="btn btn-danger" id="cancelBtn">Cancel Active Job</button>
        </div>
      </form>
    </section>

    <!-- ===== Telemetry + Molecule Viewer ===== -->
    <section class="panel reveal stagger-2">
      <h2>Telemetry</h2>
      <div class="metrics">
        <article>
          <p>Status</p>
          <strong id="metricStatus">idle</strong>
        </article>
        <article>
          <p>Return Code</p>
          <strong id="metricCode">-</strong>
        </article>
        <article>
          <p>Started</p>
          <strong id="metricStart">-</strong>
        </article>
        <article>
          <p>Finished</p>
          <strong id="metricEnd">-</strong>
        </article>
      </div>
      <p class="cmd-label">Command</p>
      <pre id="commandPreview" class="command-preview">No command yet.</pre>

      <h2 style="margin-top:20px;">Molecule Viewer</h2>
      <div class="molecule-viewer" id="moleculeViewer">
        Upload or run a single molecule to view its 3D structure
      </div>
    </section>

    <!-- ===== Live Console ===== -->
    <section class="panel wide reveal stagger-3">
      <h2>Live Console</h2>
      <pre id="logConsole" class="log-console"></pre>
    </section>

    <!-- ===== Results Snapshot ===== -->
    <section class="panel wide reveal stagger-4">
      <h2>Results Snapshot</h2>
      <div id="summaryGrid" class="summary-grid"></div>

      <!-- Scatter plot for batch results -->
      <div id="scatterPlot" style="display:none;"></div>

      <div class="table-wrap">
        <table id="resultTable">
          <thead>
            <tr>
              <th>File</th>
              <th>f1</th>
              <th>f2</th>
              <th>f3</th>
              <th>f4</th>
              <th>f5</th>
              <th>f6</th>
              <th>f7</th>
              <th>f8</th>
              <th>f9</th>
              <th>SNCI</th>
              <th>SCDI</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>
      <details id="outputExcerptWrap">
        <summary>Single-Run Output Excerpt</summary>
        <pre id="outputExcerpt"></pre>
      </details>
    </section>

    <!-- ===== Job History ===== -->
    <section class="panel wide reveal stagger-5">
      <h2>Job History</h2>
      <ul id="jobHistory" class="job-history"></ul>
    </section>
  </main>

  <div class="modal-backdrop hidden" id="multiwfnModal">
    <div class="modal-card">
      <h3>Multiwfn Setup Required</h3>
      <p>
        Multiwfn was not detected. Set the executable path (or folder containing it) to continue.
      </p>
      <label>
        Multiwfn Path
        <div class="path-row">
          <input id="multiwfnPath" type="text" placeholder="E:\path\to\Multiwfn.exe or folder" />
          <button type="button" class="btn btn-secondary browse-btn" id="browseMultiwfnFile">Exe...</button>
          <button type="button" class="btn btn-secondary browse-btn" id="browseMultiwfnDir">Folder...</button>
        </div>
      </label>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="closeMultiwfnModal">Close</button>
        <button type="button" class="btn btn-primary" id="saveMultiwfnPath">Save Path</button>
      </div>
      <p class="modal-note" id="multiwfnModalNote"></p>
    </div>
  </div>

  <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>

</html>
